{% extends "auctions/layout.html" %}

{% block body %}
<script>
    function exchangeCurrency() {
        const host = 'api.frankfurter.app';
        fetch(`https://${host}/latest?amount=100&from=EUR&to=USD`)
        .then(resp => resp.json())
        .then((data) => {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML=`<p>Exchange = ${data.rates.USD} USD</p>`;
  });

        return false;
    }
</script>

    <h2> {{listing.product}}</h2>
    <img src="{{listing.picture_url}}"/>
    {{listing.description}}
    {{listing.category}}

    <!-- Renderizado de la última bid -->
    {% for bid in listing.bid_set.all %}
        <p>{{ bid.bid }}</p>
        <form id="exchange" onsubmit="return exchangeCurrency()">
            <select id="currencies" name="currencies">
              <option value="USD">Dólar estadounidense (USD)</option>
              <option value="EUR">Euro (EUR)</option>
              <option value="GBP">Libra esterlina (GBP)</option>
              <option value="JPY">Yen japonés (JPY)</option>
            </select>
            <br>
            <input type="submit" value="Change currency">
          </form>
        <div style="background-color: red; width: 50px;" id="result">
EXCHANGE
        </div>

    {% endfor %}
    
    {% if user.is_authenticated %}
        <!-- Pujar -->
        {% if listing.is_active %}
            {% for bid in listing.bid_set.all %}
                <form action="{% url 'bid' id=bid.id %}" method="POST">
                    {% csrf_token %}
                    <input type="number" name="new_bid" placeholder="Recuerda que la nueva puja debe ser mayor que la última" min="{{ bid.bid }}">
                    <button type="submit">Puja!</button>
                </form>
            {% endfor %}
        {% endif %}

        <!-- Añadir o quitar de la lista de deseos -->
        {% if listing in request.user.watchlist.all %}
            <form action="{% url 'remove_from_watchlist' id=listing.id %}" method="post">
                {% csrf_token %}
                <button type="submit">Quitar de Watchlist</button>
            </form>
        {% else %}
            <form action="{% url 'add_to_watchlist' id=listing.id %}" method="post">
                {% csrf_token %}
                <button type="submit">Añadir a Watchlist</button>
            </form>
        {% endif %}

        <!-- Comentar -->
        <form action="{% url 'comment' id=listing.id %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="user">
            <input type="hidden" name="listing" value="{{ listing.id }}">
            <input type="textarea" name="comment" placeholder="Write your comment here">
            <button type="submit">Comment</button>
        </form>
    {% endif %}
    
    <!-- Renderización de comentarios -->
    {% for comment in listing.comment_set.all %}
        <li>{{ comment.user.username }}: {{ comment.comments }}</li>
    {% endfor %}
{% endblock %}
